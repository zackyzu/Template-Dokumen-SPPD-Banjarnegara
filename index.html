<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Template SPPD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Times+New+Roman&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .document-preview {
            font-family: 'Times New Roman', Times, serif;
            color: #000;
            background-color: #fff;
            padding: 2.5rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            position: relative;
        }
        .doc-header {
            text-align: center;
            border-bottom: 3px double #000;
            padding-bottom: 5px;
        }
        .doc-header img {
            width: 70px;
            height: auto;
            position: absolute;
            left: 2.5rem; 
            top: -0.5rem;
        }
        .doc-title {
            text-decoration: underline;
            font-weight: bold;
        }
        table.doc-table, .doc-table th, .doc-table td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 4px;
            font-size: 12pt;
        }
        .input-group {
            margin-bottom: 1rem;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
        }
        .page-break {
            page-break-after: always;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 lg:p-8">
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h1 class="text-2xl font-bold text-gray-800">Template Dokumen SPPD Banjarnegara</h1>
            <p class="text-gray-600 mt-2">Isi formulir di bawah ini untuk membuat Surat Tugas dan Surat Perjalanan Dinas. Pratinjau akan diperbarui secara otomatis.</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Kolom Formulir -->
            <div class="lg:w-1/3 bg-white p-6 rounded-xl shadow-lg h-fit sticky top-8">
                <h2 class="text-xl font-bold mb-4 border-b pb-2">Data Isian</h2>
                <form id="sppd-form">
                    <!-- Data Umum -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-lg text-gray-700">Informasi Surat</h3>
                        <div class="input-group"><label for="nomor-surat">Nomor Surat (setelah 094/)</label><input type="text" id="nomor-surat" placeholder="Contoh: 123"></div>
                        <div class="input-group"><label for="tanggal-surat">Tanggal Surat Dibuat</label><input type="date" id="tanggal-surat"></div>

                        <h3 class="font-semibold text-lg mt-4 text-gray-700">Detail Perjalanan Dinas</h3>
                        <div class="input-group"><label for="tugas">Untuk Melaksanakan Tugas</label><textarea id="tugas" rows="3">Koordinasi pelaksanaan Taping kegiatan Talks Show Bupati Banjarnegara dengan Bea Cukai Purwokerto sosialisasi DBHCHT TA anggaran 2025.</textarea></div>
                        <div class="input-group"><label for="tanggal-berangkat">Tanggal Berangkat</label><input type="date" id="tanggal-berangkat"></div>
                        <div class="input-group"><label for="tempat-tujuan">Tempat Tujuan</label><input type="text" id="tempat-tujuan" value="Semarang"></div>
                        <div class="input-group"><label for="waktu-pelaksanaan">Waktu Pelaksanaan</label><input type="text" id="waktu-pelaksanaan" value="08.00 wib s/d selesai"></div>
                        <div class="input-group"><label for="lama-perjalanan">Lama Perjalanan (hari)</label><input type="number" id="lama-perjalanan" value="1"></div>
                        <div class="input-group"><label for="alat-angkut">Alat Angkut</label><input type="text" id="alat-angkut" value="Dinas"></div>

                        <h3 class="font-semibold text-lg mt-4 text-gray-700">Pejabat Penanda Tangan</h3>
                        <div class="input-group"><label for="nama-pejabat">Nama Kepala Dinas</label><input type="text" id="nama-pejabat" value="SAGIYO, S.IP"></div>
                        <div class="input-group"><label for="nip-pejabat">NIP Kepala Dinas</label><input type="text" id="nip-pejabat" value="197210071999031007"></div>
                    </div>
                    
                    <!-- Data Pegawai Dinamis -->
                    <div class="mt-6">
                        <h3 class="font-semibold text-lg text-gray-700 border-t pt-4">Pegawai yang Ditugaskan</h3>
                        <div id="employee-list" class="space-y-4 mt-4">
                            <!-- Pegawai akan ditambahkan di sini oleh JavaScript -->
                        </div>
                        <button type="button" id="add-employee" class="mt-4 w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                            + Tambah Pegawai
                        </button>
                    </div>
                </form>
                <div class="mt-8">
                    <button id="save-pdf" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Simpan sebagai PDF
                    </button>
                </div>
            </div>

            <!-- Kolom Pratinjau -->
            <div class="lg:w-2/3" id="preview-container">
                <!-- Halaman 1: Surat Tugas (Template) -->
                <div id="page1" class="document-preview A4">
                    <div class="doc-header relative"><img src="image_539389.png" alt="Logo Banjarnegara"><h2 class="font-bold text-lg">PEMERINTAH KABUPATEN BANJARNEGARA</h2><h1 class="font-bold text-xl">DINAS KOMUNIKASI DAN INFORMATIKA</h1><p class="text-sm">Jl. A. Yani No. 16 Telp. (0286) 591043(PABX) Telex 25644, Fax. 591187 Banjarnegara 53414</p><p class="text-sm">http://banjarnegarakab.go.id E-mail : dinkominfo@banjarnegarakab.go.id</p></div>
                    <div class="body-surat mt-6 text-base">
                        <div class="text-center mb-6"><p class="doc-title">SURAT TUGAS</p><p>Nomor : 094/ <span data-preview="nomor-surat">[Nomor Surat]</span> /kominfo/2025</p></div>
                        <table class="w-full mb-4"><tr><td class="align-top w-1/6">Dasar</td><td class="align-top w-px">:</td><td class="text-justify">1. Peraturan Daerah Kabupaten Banjarnegara Nomor 14 Tahun 2024 tentang Anggaran Pendapatan dan Belanja Daerah Tahun Anggaran 2025 (Lembaran Daerah Kabupaten Banjarnegara Tahun 2024 Nomor 14);<br>2. Peraturan Bupati Banjarnegara Nomor 17 Tahun 2025 tentang Perubahan Ketiga atas Peraturan Bupati Banjarnegara Nomor 49 Tahun 2024 tentang Penjabaran Anggaran Pendapatan dan Belanja Daerah Tahun Anggaran 2025; tanggal 27 Maret 2025</td></tr></table>
                        <p class="mb-2">Dengan ini ditugaskan kepada :</p>
                        <table class="doc-table w-full mb-4"><thead class="bg-gray-100"><tr><th class="w-8">NO</th><th>NAMA</th><th>NIP</th><th>Pangkat / Gol</th><th>Jabatan</th></tr></thead><tbody id="employee-table-preview"></tbody></table>
                        <p class="mb-2">Untuk melaksanakan Tugas : <span data-preview="tugas">[Tugas]</span> sebagai berikut :</p>
                        <table class="mb-4 ml-8">
                            <tr><td>Hari/Tanggal</td><td class="px-2">:</td><td><span data-preview="hari-tanggal">[Hari, Tanggal Berangkat]</span></td></tr>
                            <tr><td>Tempat</td><td class="px-2">:</td><td><span data-preview="tempat-tujuan">[Tempat Tujuan]</span></td></tr>
                            <tr><td>Pukul</td><td class="px-2">:</td><td><span data-preview="waktu-pelaksanaan">[Waktu Pelaksanaan]</span></td></tr>
                        </table>
                        <p class="mb-6">Setelah melaksanakan Tugas harap melaporkan hasil pelaksanaanya. Demikian untuk menjadikan perhatian dan dilaksanakan dengan penuh tanggung jawab.</p>
                        <div class="flex justify-end"><div class="text-center w-1/2"><p>Banjarnegara, <span data-preview="tanggal-surat">[Tanggal Surat]</span></p><p>Kepala Dinas Komunikasi dan Informatika</p><p>Kabupaten Banjarnegara</p><div class="h-20"></div><p class="font-bold underline"><span data-preview="nama-pejabat">[Nama Pejabat]</span></p><p>NIP. <span data-preview="nip-pejabat">[NIP Pejabat]</span></p></div></div>
                    </div>
                </div>
                <!-- SPPD akan digenerate di sini oleh JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Template untuk halaman SPPD (disembunyikan) -->
    <template id="sppd-page-template">
        <div class="document-preview A4 sppd-page">
            <div class="doc-header relative"><img src="image_539389.png" alt="Logo Banjarnegara"><h2 class="font-bold text-lg">PEMERINTAH KABUPATEN BANJARNEGARA</h2><h1 class="font-bold text-xl">DINAS KOMUNIKASI DAN INFORMATIKA</h1><p class="text-sm">Jl. A. Yani No. 16 Telp. (0286) 591043(PABX) Telex 25644, Fax. 591187 Banjarnegara 53414</p><p class="text-sm">http://banjarnegarakab.go.id E-mail : dinkominfo@banjarnegarakab.go.id</p></div>
            <div class="mt-4"><table class="w-full"><tr><td class="w-1/4">PROVINSI</td><td>: JAWA TENGAH</td></tr><tr><td>KABUPATEN</td><td>: BANJARNEGARA</td></tr></table><div class="text-center my-2"><p class="doc-title">SURAT PERJALANAN DINAS</p><p>Nomor : 094/ <span data-preview="nomor-surat">[Nomor Surat]</span> /kominfo/2025</p></div></div>
            <table class="doc-table w-full text-sm">
                <tr><td class="w-8 text-center">1.</td><td class="w-1/3">Nama</td><td colspan="2"><span data-preview="nama-pegawai">[Nama Pegawai]</span></td></tr>
                <tr><td class="text-center">2.</td><td>NIP</td><td colspan="2"><span data-preview="nip-pegawai">[NIP]</span></td></tr>
                <tr><td class="text-center">3.</td><td>Pangkat dan Golongan</td><td colspan="2"><span data-preview="pangkat-gol">[Pangkat/Gol]</span></td></tr>
                <tr><td class="text-center">4.</td><td>Jabatan/Instansi</td><td colspan="2"><span data-preview="jabatan">[Jabatan]</span> / Dinas Kominfo Kabupaten Banjarnegara</td></tr>
                <tr><td class="text-center">5.</td><td>Tingkat Biaya Perjalanan Dinas</td><td colspan="2">C</td></tr>
                <tr><td class="text-center">6.</td><td>Maksud Perjalanan Dinas</td><td colspan="2"><span data-preview="tugas">[Tugas]</span></td></tr>
                <tr><td class="text-center">7.</td><td>Alat Angkutan yang dipergunakan</td><td colspan="2"><span data-preview="alat-angkut">[Alat Angkut]</span></td></tr>
                <tr><td class="text-center">8.</td><td>a. Tempat Berangkat<br>b. Tempat Tujuan</td><td colspan="2">a. Banjarnegara<br>b. <span data-preview="tempat-tujuan">[Tempat Tujuan]</span></td></tr>
                <tr><td class="text-center">9.</td><td>a. Lamanya Perjalanan Dinas<br>b. Tanggal Berangkat<br>c. Tanggal harus kembali</td><td colspan="2">a. <span data-preview="lama-perjalanan">[Lama Perjalanan]</span> hari<br>b. <span data-preview="tanggal-berangkat">[Tanggal Berangkat]</span><br>c. <span data-preview="tanggal-kembali">[Tanggal Kembali]</span></td></tr>
                <tr><td class="text-center">10.</td><td>Pembebanan Anggaran<br>a. Instansi<br>b. Akun</td><td colspan="2"><br>a. Dinas Komunikasi dan Informatika<br>b. APBD Kabupaten Banjarnegara</td></tr>
                <tr><td class="text-center">11.</td><td>Keterangan Lain-lain</td><td colspan="2">-</td></tr>
            </table>
            <div class="w-full flex justify-end mt-4"><div class="w-1/2 text-center"><p>Dikeluarkan di: Banjarnegara</p><p>Tanggal: <span data-preview="tanggal-surat">[Tanggal Surat]</span></p><p>Kepala Dinas Komunikasi dan Informatika</p><p>Kabupaten Banjarnegara</p><div class="h-20"></div><p class="font-bold underline"><span data-preview="nama-pejabat">[Nama Pejabat]</span></p><p>Pembina Tk. I</p><p>NIP. <span data-preview="nip-pejabat">[NIP Pejabat]</span></p></div></div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('sppd-form');
            const addEmployeeBtn = document.getElementById('add-employee');
            const employeeListContainer = document.getElementById('employee-list');
            let employeeCount = 0;

            // Fungsi untuk menambahkan form pegawai baru
            function addEmployeeForm() {
                employeeCount++;
                const employeeId = employeeCount;
                const employeeFormHTML = `
                    <div id="employee-${employeeId}" class="p-4 border rounded-lg relative">
                        <p class="font-bold mb-2">Pegawai ${employeeId}</p>
                        <div class="space-y-2">
                            <div class="input-group"><label>Nama Pegawai</label><input type="text" class="employee-name" data-id="${employeeId}"></div>
                            <div class="input-group"><label>NIP</label><input type="text" class="employee-nip" data-id="${employeeId}"></div>
                            <div class="input-group"><label>Pangkat / Golongan</label><input type="text" class="employee-pangkat" data-id="${employeeId}"></div>
                            <div class="input-group"><label>Jabatan</label><input type="text" class="employee-jabatan" data-id="${employeeId}"></div>
                        </div>
                        <button type="button" class="remove-employee absolute top-2 right-2 text-red-500 hover:text-red-700" data-id="${employeeId}">&times;</button>
                    </div>
                `;
                employeeListContainer.insertAdjacentHTML('beforeend', employeeFormHTML);
            }

            // Event listener untuk tombol tambah pegawai
            addEmployeeBtn.addEventListener('click', addEmployeeForm);

            // Event listener untuk tombol hapus pegawai (delegasi event)
            employeeListContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-employee')) {
                    const id = e.target.dataset.id;
                    document.getElementById(`employee-${id}`).remove();
                    updatePreview(); // Perbarui pratinjau setelah menghapus
                }
            });

            // Inisialisasi dengan satu pegawai
            addEmployeeForm();

            // Fungsi format tanggal
            function formatTanggalIndonesia(dateString) { if (!dateString) return ''; return new Date(dateString).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }); }
            function getNamaHari(dateString) { if (!dateString) return ''; return new Date(dateString).toLocaleDateString('id-ID', { weekday: 'long' }); }

            // Fungsi utama untuk memperbarui pratinjau
            function updatePreview() {
                // 1. Kumpulkan semua data umum
                const generalData = {
                    nomorSurat: document.getElementById('nomor-surat').value || '[Nomor Surat]',
                    tanggalSurat: formatTanggalIndonesia(document.getElementById('tanggal-surat').value),
                    tugas: document.getElementById('tugas').value || '[Tugas]',
                    tempatTujuan: document.getElementById('tempat-tujuan').value || '[Tempat Tujuan]',
                    waktuPelaksanaan: document.getElementById('waktu-pelaksanaan').value || '[Waktu Pelaksanaan]',
                    alatAngkut: document.getElementById('alat-angkut').value || '[Alat Angkut]',
                    namaPejabat: document.getElementById('nama-pejabat').value || '[Nama Pejabat]',
                    nipPejabat: document.getElementById('nip-pejabat').value || '[NIP Pejabat]',
                    lamaPerjalanan: document.getElementById('lama-perjalanan').value || '[Lama]',
                    tanggalBerangkat: formatTanggalIndonesia(document.getElementById('tanggal-berangkat').value),
                    hariTanggal: `${getNamaHari(document.getElementById('tanggal-berangkat').value)}, ${formatTanggalIndonesia(document.getElementById('tanggal-berangkat').value)}`,
                    tanggalKembali: ''
                };
                
                const tanggalBerangkatValue = document.getElementById('tanggal-berangkat').value;
                if (tanggalBerangkatValue && generalData.lamaPerjalanan) {
                    const startDate = new Date(tanggalBerangkatValue);
                    startDate.setDate(startDate.getDate() + parseInt(generalData.lamaPerjalanan) - 1);
                    generalData.tanggalKembali = formatTanggalIndonesia(startDate.toISOString().split('T')[0]);
                }

                // 2. Kumpulkan data semua pegawai
                const employees = [];
                document.querySelectorAll('#employee-list > div').forEach(div => {
                    employees.push({
                        id: div.id.split('-')[1],
                        nama: div.querySelector('.employee-name').value || '',
                        nip: div.querySelector('.employee-nip').value || '',
                        pangkat: div.querySelector('.employee-pangkat').value || '',
                        jabatan: div.querySelector('.employee-jabatan').value || ''
                    });
                });
                
                // Urutkan ulang nomor pegawai di form
                document.querySelectorAll('#employee-list > div .font-bold').forEach((p, index) => {
                    p.textContent = `Pegawai ${index + 1}`;
                });


                // 3. Update Halaman 1 (Surat Tugas)
                document.querySelectorAll('[data-preview]').forEach(el => {
                    if (generalData[el.dataset.preview]) {
                        el.textContent = generalData[el.dataset.preview];
                    }
                });

                const employeeTablePreview = document.getElementById('employee-table-preview');
                employeeTablePreview.innerHTML = ''; // Kosongkan tabel
                employees.forEach((emp, index) => {
                    if (emp.nama) { // Hanya tampilkan jika nama diisi
                        employeeTablePreview.innerHTML += `
                            <tr>
                                <td class="text-center">${index + 1}.</td>
                                <td>${emp.nama}</td>
                                <td>${emp.nip}</td>
                                <td class="text-center">${emp.pangkat}</td>
                                <td>${emp.jabatan}</td>
                            </tr>
                        `;
                    }
                });

                // 4. Generate Halaman SPPD untuk setiap pegawai
                const previewContainer = document.getElementById('preview-container');
                // Hapus SPPD lama
                previewContainer.querySelectorAll('.sppd-page').forEach(page => page.remove());

                const sppdTemplate = document.getElementById('sppd-page-template');
                employees.forEach(emp => {
                    if (!emp.nama) return; // Jangan buat SPPD jika nama kosong

                    const clone = sppdTemplate.content.cloneNode(true);
                    const newPage = clone.querySelector('.document-preview');

                    // Isi data umum
                    newPage.querySelector('[data-preview="nomor-surat"]').textContent = generalData.nomorSurat;
                    newPage.querySelector('[data-preview="tugas"]').textContent = generalData.tugas;
                    newPage.querySelector('[data-preview="alat-angkut"]').textContent = generalData.alatAngkut;
                    newPage.querySelector('[data-preview="tempat-tujuan"]').textContent = generalData.tempatTujuan;
                    newPage.querySelector('[data-preview="lama-perjalanan"]').textContent = generalData.lamaPerjalanan;
                    newPage.querySelector('[data-preview="tanggal-berangkat"]').textContent = generalData.tanggalBerangkat;
                    newPage.querySelector('[data-preview="tanggal-kembali"]').textContent = generalData.tanggalKembali;
                    newPage.querySelector('[data-preview="tanggal-surat"]').textContent = generalData.tanggalSurat;
                    newPage.querySelector('[data-preview="nama-pejabat"]').textContent = generalData.namaPejabat;
                    newPage.querySelector('[data-preview="nip-pejabat"]').textContent = generalData.nipPejabat;

                    // Isi data spesifik pegawai
                    newPage.querySelector('[data-preview="nama-pegawai"]').textContent = emp.nama;
                    newPage.querySelector('[data-preview="nip-pegawai"]').textContent = emp.nip;
                    newPage.querySelector('[data-preview="pangkat-gol"]').textContent = emp.pangkat;
                    newPage.querySelector('[data-preview="jabatan"]').textContent = emp.jabatan;

                    previewContainer.appendChild(newPage);
                });
            }

            // Panggil updatePreview saat ada input di form
            form.addEventListener('input', updatePreview);
            updatePreview(); // Panggil sekali saat load

            // Fungsi untuk menyimpan sebagai PDF multi-halaman
            document.getElementById('save-pdf').addEventListener('click', async function () {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pages = document.querySelectorAll('.document-preview');
                const button = this;

                button.textContent = 'Membuat PDF...';
                button.disabled = true;

                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];
                    const canvas = await html2canvas(page, { scale: 2 });
                    const imgData = canvas.toDataURL('image/png');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    if (i > 0) {
                        pdf.addPage();
                    }
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                }

                pdf.save('SPPD_Generated_Multi-Page.pdf');
                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>Simpan sebagai PDF';
                button.disabled = false;
            });
        });
    </script>
</body>
</html>
